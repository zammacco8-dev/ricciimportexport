<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Magazzino Food Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #062318;
      --bg-card: #0f2f22;
      --accent: #1dbf73;
      --accent-soft: rgba(29, 191, 115, 0.12);
      --accent-strong: rgba(29, 191, 115, 0.4);
      --text-main: #ffffff;
      --text-soft: #c9e2d7;
      --danger: #ff4b5c;
      --border-soft: #164532;
      --input-bg: #0b251a;
      --input-border: #254e3b;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.5);
      --radius-lg: 16px;
      --transition-fast: 0.15s ease-out;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(
        circle at top,
        #10422f 0,
        #02110b 45%,
        #000000 100%
      );
      color: var(--text-main);
    }

    .app-shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 12px 32px;
    }

    header.app-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 14px;
    }

    .app-title {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-circle {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(
        circle at 30% 20%,
        #4fffac,
        #1dbf73 55%,
        #0a3b27 100%
      );
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      box-shadow: 0 0 14px rgba(29, 191, 115, 0.7);
    }

    .app-subtitle {
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      align-self: flex-start;
    }

    @media (min-width: 768px) {
      header.app-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-end;
      }

      .app-title {
        font-size: 1.7rem;
      }

      .header-right {
        align-self: center;
      }
    }

    .tab-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 14px;
      background: rgba(3, 12, 8, 0.7);
      padding: 4px;
      border-radius: 999px;
      border: 1px solid rgba(29, 191, 115, 0.18);
    }

    .tab-button {
      flex: 1;
      min-width: 90px;
      border: none;
      background: transparent;
      color: var(--text-soft);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition:
        background var(--transition-fast),
        color var(--transition-fast),
        transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    .tab-button::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(
        circle at 10% 0,
        rgba(255, 255, 255, 0.18),
        transparent 60%
      );
      opacity: 0;
      transition: opacity var(--transition-fast);
      pointer-events: none;
    }

    .tab-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.45);
    }

    .tab-button:active {
      transform: translateY(0);
      box-shadow: 0 0 0 rgba(0, 0, 0, 0);
    }

    .tab-button.active {
      background: linear-gradient(135deg, var(--accent), #11a161);
      color: #02110a;
      font-weight: 600;
      box-shadow: 0 0 18px rgba(29, 191, 115, 0.7);
    }

    .tab-button.active::after {
      opacity: 0.3;
    }

    .tab-icon {
      font-size: 1rem;
    }

    .card {
      background: linear-gradient(
        145deg,
        rgba(5, 27, 17, 0.95),
        rgba(8, 39, 24, 0.98)
      );
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      padding: 12px 12px 14px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 8px;
    }

    .card-title {
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .card-subtitle {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid var(--accent-strong);
      backdrop-filter: blur(8px);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    label {
      font-size: 0.75rem;
      color: var(--text-soft);
      display: block;
      margin-bottom: 3px;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    input[type="file"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-main);
      font-size: 0.8rem;
      outline: none;
      transition:
        border-color var(--transition-fast),
        box-shadow var(--transition-fast),
        transform var(--transition-fast),
        background var(--transition-fast);
    }

    input[type="file"] {
      padding: 4px;
      font-size: 0.75rem;
    }

    input:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(29, 191, 115, 0.5);
      transform: translateY(-1px);
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      justify-content: center;
      background: linear-gradient(135deg, #1dbf73, #10a05f);
      color: #02110a;
      position: relative;
      overflow: hidden;
      transition:
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        filter var(--transition-fast);
      box-shadow: 0 0 12px rgba(29, 191, 115, 0.7);
    }

    .btn::after {
      content: "";
      position: absolute;
      top: -60%;
      left: -20%;
      width: 50%;
      height: 220%;
      background: linear-gradient(
        120deg,
        rgba(255, 255, 255, 0.25),
        transparent
      );
      transform: translateX(-100%);
      transition: transform 0.4s ease-out;
      pointer-events: none;
    }

    .btn:hover::after {
      transform: translateX(260%);
    }

    .btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.08);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.8);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
      filter: brightness(0.95);
    }

    .btn-secondary {
      background: transparent;
      color: var(--accent);
      border: 1px solid rgba(29, 191, 115, 0.5);
      box-shadow: none;
    }

    .btn-secondary::after {
      background: radial-gradient(
        circle at 0 0,
        rgba(255, 255, 255, 0.2),
        transparent
      );
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #ff7a85);
      color: #2b0004;
      box-shadow: 0 0 12px rgba(255, 75, 92, 0.7);
    }

    .btn-small {
      padding: 4px 9px;
      font-size: 0.72rem;
    }

    .btn-icon {
      font-size: 0.9rem;
    }

    .btn-fullscreen {
      border-radius: 999px;
      padding: 5px 9px;
      min-width: 32px;
      justify-content: center;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .toolbar-left,
    .toolbar-right {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .search-input {
      min-width: 170px;
    }

    .table-wrapper {
      max-height: 320px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: radial-gradient(
        circle at top left,
        rgba(29, 191, 115, 0.13),
        rgba(3, 17, 11, 0.95)
      );
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      text-align: left;
      vertical-align: middle;
    }

    th {
      position: sticky;
      top: 0;
      background: rgba(3, 12, 8, 0.94);
      z-index: 1;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--accent);
    }

    tr:nth-child(even) {
      background: rgba(5, 21, 14, 0.7);
    }

    tr:hover {
      background: rgba(13, 115, 74, 0.37);
    }

    .badge {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.68rem;
      border: 1px solid rgba(255, 255, 255, 0.18);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .badge-cat {
      border-color: rgba(29, 191, 115, 0.6);
      color: var(--accent);
    }

    .badge-status-open {
      border-color: rgba(255, 214, 102, 0.8);
      color: #ffd666;
    }

    .badge-status-closed {
      border-color: rgba(29, 191, 115, 0.8);
      color: var(--accent);
    }

    .thumbnail {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .text-right {
      text-align: right;
    }

    .text-small {
      font-size: 0.7rem;
    }

    .muted {
      color: rgba(201, 226, 215, 0.7);
    }

    .hint {
      font-size: 0.7rem;
      color: rgba(201, 226, 215, 0.8);
      margin-top: 2px;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .chip {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 0.7rem;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(3, 16, 11, 0.8);
      color: var(--text-soft);
      cursor: pointer;
      transition:
        background var(--transition-fast),
        border-color var(--transition-fast),
        transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    .chip.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 8px rgba(29, 191, 115, 0.6);
      transform: translateY(-1px);
    }

    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .grow {
      flex: 1;
    }

    .barcode-preview {
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(5, 21, 14, 0.9);
      border: 1px dashed rgba(29, 191, 115, 0.55);
      font-size: 0.75rem;
      margin-top: 6px;
    }

    .toast {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.92);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 0.78rem;
      color: #ffffff;
      border: 1px solid rgba(29, 191, 115, 0.6);
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.8);
      z-index: 9999;
      display: none;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div>
        <div class="app-title">
          <div class="logo-circle">M</div>
          Magazzino Food Manager
        </div>
        <div class="app-subtitle">
          Gestione prodotti, carico/scarico, ordini e barcode ‚Äì tutto in un‚Äôunica app.
        </div>
      </div>
      <div class="header-right">
        <button class="btn-secondary btn-small btn-fullscreen" id="fullscreenToggle" title="Schermo intero">
          <span class="btn-icon" id="fullscreenIcon">‚õ∂</span>
        </button>
        <div class="pill">
          Forest Green UI ‚Ä¢ Cloud Sync
        </div>
      </div>
    </header>

    <nav class="tab-bar">
      <button class="tab-button active" data-tab="inventario">
        <span class="tab-icon">üì¶</span>
        <span>Inventario</span>
      </button>
      <button class="tab-button" data-tab="movimenti">
        <span class="tab-icon">üîÅ</span>
        <span>Carico / Scarico</span>
      </button>
      <button class="tab-button" data-tab="ordini">
        <span class="tab-icon">üßæ</span>
        <span>Ordini</span>
      </button>
      <button class="tab-button" data-tab="barcode">
        <span class="tab-icon">üì∑</span>
        <span>Barcode</span>
      </button>
    </nav>

    <!-- INVENTARIO -->
    <section class="section active" id="inventario">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Nuovo prodotto</div>
            <div class="card-subtitle">
              Inserisci i prodotti per popolare il magazzino iniziale (inventario).
            </div>
          </div>
          <span class="pill">Step 1 ‚Ä¢ Inventario</span>
        </div>

        <div class="chips-row" id="categoryChips">
          <button class="chip active" data-category="formaggi">Formaggi</button>
          <button class="chip" data-category="verdure">Verdure</button>
          <button class="chip" data-category="carne">Carne / Insaccati</button>
          <button class="chip" data-category="scatolame">Scatolame</button>
          <button class="chip" data-category="dolci">Dolci</button>
          <button class="chip" data-category="secco">Secco</button>
        </div>

        <form id="productForm">
          <div class="form-grid">
            <div>
              <label for="productName">Nome prodotto</label>
              <input
                type="text"
                id="productName"
                placeholder="Es. Mozzarella di bufala"
                required
              />
            </div>
            <div>
              <label for="productCategory">Categoria</label>
              <select id="productCategory">
                <option value="formaggi">Formaggi</option>
                <option value="verdure">Verdure</option>
                <option value="carne">Carne / Insaccati</option>
                <option value="scatolame">Scatolame</option>
                <option value="dolci">Dolci</option>
                <option value="secco">Secco</option>
              </select>
              <div class="hint">Si sincronizza con i pulsanti sopra.</div>
            </div>
            <div>
              <label for="productQuantity">Quantit√† iniziale</label>
              <input
                type="number"
                id="productQuantity"
                min="0"
                step="0.01"
                value="0"
              />
            </div>
            <div>
              <label for="purchasePrice">Prezzo di acquisto (‚Ç¨)</label>
              <input
                type="number"
                id="purchasePrice"
                min="0"
                step="0.01"
                value="0"
              />
            </div>
            <div>
              <label for="markupPercent">Ricarico %</label>
              <input
                type="number"
                id="markupPercent"
                min="0"
                step="1"
                value="30"
              />
              <div class="hint">
                Viene usato per calcolare in automatico il prezzo di vendita.
              </div>
            </div>
            <div>
              <label for="salePrice">Prezzo di vendita (‚Ç¨)</label>
              <input
                type="number"
                id="salePrice"
                min="0"
                step="0.01"
                value="0"
              />
              <div class="hint" id="salePriceHint">
                Verr√† aggiornato automaticamente in base al ricarico.
              </div>
            </div>
            <div>
              <label for="purchaseDate">Data di acquisto</label>
              <input type="date" id="purchaseDate" />
            </div>
            <div>
              <label for="expiryDate">Data di scadenza</label>
              <input type="date" id="expiryDate" />
            </div>
            <div>
              <label for="barcode">Barcode (opzionale)</label>
              <input
                type="text"
                id="barcode"
                placeholder="Codice a barre / EAN"
              />
              <div class="hint">
                Verr√† usato per la ricerca rapida nella sezione Barcode.
              </div>
            </div>
            <div>
              <label for="photo">Foto prodotto (opzionale)</label>
              <input type="file" id="photo" accept="image/*" />
              <div class="hint">
                L‚Äôimmagine viene salvata come base64 in locale (non su Firebase Storage).
              </div>
            </div>
          </div>

          <div class="flex-row" style="justify-content: space-between; margin-top: 6px;">
            <button type="submit" class="btn">
              <span class="btn-icon">‚ûï</span>
              <span>Aggiungi / Aggiorna prodotto</span>
            </button>
            <button type="button" class="btn-secondary btn-small" id="clearProductForm">
              Pulisci campi
            </button>
          </div>
        </form>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Lista prodotti</div>
            <div class="card-subtitle">
              Inventario corrente per tutte le categorie.
            </div>
          </div>
          <span class="pill" id="inventoryCountPill">0 prodotti</span>
        </div>

        <div class="toolbar">
          <div class="toolbar-left">
            <input
              type="text"
              id="searchInput"
              class="search-input"
              placeholder="Cerca prodotto o barcode..."
            />
          </div>
          <div class="toolbar-right">
            <select id="filterCategory">
              <option value="all">Tutte le categorie</option>
              <option value="formaggi">Formaggi</option>
              <option value="verdure">Verdure</option>
              <option value="carne">Carne / Insaccati</option>
              <option value="scatolame">Scatolame</option>
              <option value="dolci">Dolci</option>
              <option value="secco">Secco</option>
            </select>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Foto</th>
                <th>Nome</th>
                <th>Categoria</th>
                <th class="text-right">Q.t√†</th>
                <th class="text-right">Acquisto</th>
                <th class="text-right">Vendita</th>
                <th>Scadenza</th>
                <th>Barcode</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody id="productsTableBody"></tbody>
          </table>
        </div>

        <div class="hint" style="margin-top: 6px;">
          Tocca un prodotto nella tabella per modificarlo. Le modifiche vengono salvate
          su questo dispositivo e sul cloud (Firestore ‚Üí documento "warehouse/state").
        </div>
      </div>
    </section>

    <!-- MOVIMENTI -->
    <section class="section" id="movimenti">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Carico / Scarico</div>
            <div class="card-subtitle">
              Registra entrate (carico) e uscite (scarico) per tenere aggiornato il magazzino.
            </div>
          </div>
          <span class="pill">Step 2 ‚Ä¢ Movimenti</span>
        </div>

        <form id="movementForm">
          <div class="form-grid">
            <div>
              <label for="movementType">Tipo movimento</label>
              <select id="movementType">
                <option value="carico">Carico (entrata)</option>
                <option value="scarico">Scarico (uscita)</option>
              </select>
            </div>
            <div>
              <label for="movementProduct">Prodotto</label>
              <select id="movementProduct"></select>
              <div class="hint">
                Elenco basato sui prodotti dell‚Äôinventario.
              </div>
            </div>
            <div>
              <label for="movementQuantity">Quantit√†</label>
              <input
                type="number"
                id="movementQuantity"
                min="0"
                step="0.01"
                value="0"
              />
            </div>
            <div>
              <label for="movementDate">Data</label>
              <input type="date" id="movementDate" />
            </div>
            <div>
              <label for="movementNote">Nota (opzionale)</label>
              <input
                type="text"
                id="movementNote"
                placeholder="Es. Carico da fornitore X"
              />
            </div>
          </div>

          <div class="flex-row" style="justify-content: space-between; margin-top: 6px;">
            <button type="submit" class="btn">
              <span class="btn-icon">‚ûï</span>
              <span>Registra movimento</span>
            </button>
            <button
              type="button"
              class="btn-secondary btn-small"
              id="clearMovementForm"
            >
              Pulisci campi
            </button>
          </div>
        </form>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Storico movimenti</div>
            <div class="card-subtitle">
              Elenco di carichi e scarichi recenti.
            </div>
          </div>
          <span class="pill" id="movementsCountPill">0 movimenti</span>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Prodotto</th>
                <th>Tipo</th>
                <th class="text-right">Q.t√†</th>
                <th>Nota</th>
              </tr>
            </thead>
            <tbody id="movementsTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ORDINI -->
    <section class="section" id="ordini">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Nuovo ordine</div>
            <div class="card-subtitle">
              Crea una lista d‚Äôordine basata sui prodotti in magazzino.
            </div>
          </div>
          <span class="pill">Step 3 ‚Ä¢ Ordini</span>
        </div>

        <form id="orderItemForm">
          <div class="form-grid">
            <div>
              <label for="orderProduct">Prodotto</label>
              <select id="orderProduct"></select>
              <div class="hint">I prodotti vengono dall‚Äôinventario.</div>
            </div>
            <div>
              <label for="orderQuantity">Quantit√† da ordinare</label>
              <input
                type="number"
                id="orderQuantity"
                min="0"
                step="0.01"
                value="0"
              />
            </div>
            <div>
              <label for="orderNote">Nota (opzionale)</label>
              <input
                type="text"
                id="orderNote"
                placeholder="Es. per weekend / evento"
              />
            </div>
          </div>

          <div class="flex-row" style="justify-content: space-between; margin-top: 6px;">
            <button type="submit" class="btn">
              <span class="btn-icon">‚ûï</span>
              <span>Aggiungi all‚Äôordine</span>
            </button>
            <button
              type="button"
              class="btn-secondary btn-small"
              id="clearOrderItemForm"
            >
              Pulisci campi
            </button>
          </div>
        </form>

        <div class="card" style="margin-top: 10px;">
          <div class="card-header">
            <div>
              <div class="card-title">Ordine corrente</div>
              <div class="card-subtitle">
                Riepilogo elementi prima di confermare l‚Äôordine.
              </div>
            </div>
            <span class="pill" id="currentOrderCountPill">0 righe</span>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Prodotto</th>
                  <th class="text-right">Q.t√†</th>
                  <th>Note</th>
                  <th>Azioni</th>
                </tr>
              </thead>
              <tbody id="currentOrderTableBody"></tbody>
            </table>
          </div>

          <div class="flex-row" style="justify-content: flex-end; margin-top: 6px;">
            <button type="button" class="btn-secondary btn-small" id="clearCurrentOrder">
              Svuota ordine
            </button>
            <button type="button" class="btn btn-small" id="confirmOrder">
              ‚úÖ Conferma ordine
            </button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Storico ordini</div>
            <div class="card-subtitle">
              Vedi gli ordini salvati ed evadili aggiornando il magazzino.
            </div>
          </div>
          <span class="pill" id="ordersCountPill">0 ordini</span>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Descrizione</th>
                <th class="text-right">Righe</th>
                <th>Stato</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody id="ordersTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BARCODE -->
    <section class="section" id="barcode">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Ricerca tramite barcode</div>
            <div class="card-subtitle">
              Cerca un prodotto partendo dal codice a barre o appoggiandoti a servizi esterni.
            </div>
          </div>
          <span class="pill">Extra ‚Ä¢ Barcode</span>
        </div>

        <div class="form-grid">
          <div>
            <label for="barcodeSearchInput">Barcode</label>
            <input
              type="text"
              id="barcodeSearchInput"
              placeholder="Inserisci barcode..."
            />
          </div>
        </div>

        <div class="flex-row" style="margin-top: 6px; justify-content: flex-start;">
          <button type="button" class="btn-small btn-secondary" id="searchBarcodeLocal">
            üîç Cerca nel magazzino
          </button>
          <button type="button" class="btn-small btn-secondary" id="searchBarcodeExternal">
            üåê Cerca online
          </button>
        </div>

        <div class="barcode-preview" id="barcodeResultBox">
          Nessun barcode cercato.
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // Config del tuo progetto ricci-a1e3a
    const firebaseConfig = {
      apiKey: "AIzaSyAH5b0SvCxQoJUmER9jD3UMChvprRWGsE",
      authDomain: "ricci-a1e3a.firebaseapp.com",
      projectId: "ricci-a1e3a",
      storageBucket: "ricci-a1e3a.firebasestorage.app",
      messagingSenderId: "919882200496",
      appId: "1:919882200496:web:ef1cf3b9d8c80093759275",
      measurementId: "G-G5MYXMED4V"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const stateDocRef = db.collection("warehouse").doc("state");
  </script>

  <script>
    // ---------------- DATA MODEL ----------------
    const STORAGE_KEYS = {
      PRODUCTS: "warehouse_products",
      MOVEMENTS: "warehouse_movements",
      ORDERS: "warehouse_orders",
      CURRENT_ORDER: "warehouse_current_order",
    };

    let products = [];
    let movements = [];
    let orders = [];
    let currentOrderItems = [];

    // ---------------- UI HELPERS ----------------
    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.style.display = "block";
      setTimeout(() => {
        toast.style.display = "none";
      }, 2200);
    }

    function formatCurrency(value) {
      const num = Number(value) || 0;
      return (
        num.toLocaleString("it-IT", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }) + " ‚Ç¨"
      );
    }

    function formatDate(dateStr) {
      if (!dateStr) return "-";
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      return dd + "/" + mm + "/" + yyyy;
    }

    function todayISO() {
      const d = new Date();
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      return yyyy + "-" + mm + "-" + dd;
    }

    function readableCategory(cat) {
      switch (cat) {
        case "formaggi":
          return "Formaggi";
        case "verdure":
          return "Verdure";
        case "carne":
          return "Carne / Insaccati";
        case "scatolame":
          return "Scatolame";
        case "dolci":
          return "Dolci";
        case "secco":
          return "Secco";
        default:
          return cat || "-";
      }
    }

    // ---------------- PERSISTENZA ----------------
    function saveLocal() {
      localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
      localStorage.setItem(STORAGE_KEYS.MOVEMENTS, JSON.stringify(movements));
      localStorage.setItem(STORAGE_KEYS.ORDERS, JSON.stringify(orders));
      localStorage.setItem(
        STORAGE_KEYS.CURRENT_ORDER,
        JSON.stringify(currentOrderItems)
      );
    }

    async function syncToCloud() {
      try {
        await stateDocRef.set(
          {
            products,
            movements,
            orders,
            currentOrderItems,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          },
          { merge: true }
        );
      } catch (e) {
        console.error("Errore sync cloud:", e);
      }
    }

    async function loadFromCloud() {
      try {
        const snap = await stateDocRef.get();
        if (!snap.exists) return false;
        const data = snap.data() || {};
        products = data.products || [];
        movements = data.movements || [];
        orders = data.orders || [];
        currentOrderItems = data.currentOrderItems || [];
        saveLocal();
        return true;
      } catch (e) {
        console.error("Errore load cloud:", e);
        return false;
      }
    }

    function saveAndSync() {
      saveLocal();
      syncToCloud();
    }

    // ---------------- FULLSCREEN ----------------
    const fullscreenBtn = document.getElementById("fullscreenToggle");
    const fullscreenIcon = document.getElementById("fullscreenIcon");

    function isFullscreen() {
      return (
        document.fullscreenElement ||
        document.webkitFullscreenElement ||
        document.mozFullScreenElement ||
        document.msFullscreenElement
      );
    }

    function updateFullscreenIcon() {
      if (isFullscreen()) {
        fullscreenIcon.textContent = "ü°º";
        fullscreenBtn.title = "Esci da schermo intero";
      } else {
        fullscreenIcon.textContent = "‚õ∂";
        fullscreenBtn.title = "Schermo intero";
      }
    }

    async function toggleFullscreen() {
      try {
        if (!isFullscreen()) {
          if (document.documentElement.requestFullscreen) {
            await document.documentElement.requestFullscreen();
          } else if (document.documentElement.webkitRequestFullscreen) {
            await document.documentElement.webkitRequestFullscreen();
          }
        } else {
          if (document.exitFullscreen) {
            await document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            await document.webkitExitFullscreen();
          }
        }
      } catch (e) {
        console.error("Errore fullscreen:", e);
      } finally {
        updateFullscreenIcon();
      }
    }

    fullscreenBtn.addEventListener("click", toggleFullscreen);
    document.addEventListener("fullscreenchange", updateFullscreenIcon);

    // ---------------- TABS ----------------
    const tabs = document.querySelectorAll(".tab-button");
    const sections = document.querySelectorAll(".section");

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        const target = tab.getAttribute("data-tab");
        tabs.forEach((t) => t.classList.remove("active"));
        sections.forEach((s) => s.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(target).classList.add("active");
      });
    });

    // ---------------- ELEMENTI DOM ----------------
    const categoryChips = document.getElementById("categoryChips");
    const productCategorySelect = document.getElementById("productCategory");

    const productForm = document.getElementById("productForm");
    const productNameInput = document.getElementById("productName");
    const productCategoryInput = document.getElementById("productCategory");
    const productQuantityInput = document.getElementById("productQuantity");
    const purchasePriceInput = document.getElementById("purchasePrice");
    const markupPercentInput = document.getElementById("markupPercent");
    const salePriceInput = document.getElementById("salePrice");
    const purchaseDateInput = document.getElementById("purchaseDate");
    const expiryDateInput = document.getElementById("expiryDate");
    const barcodeInput = document.getElementById("barcode");
    const photoInput = document.getElementById("photo");
    const salePriceHint = document.getElementById("salePriceHint");
    const clearProductFormBtn = document.getElementById("clearProductForm");

    const productsTableBody = document.getElementById("productsTableBody");
    const inventoryCountPill = document.getElementById("inventoryCountPill");
    const filterCategorySelect = document.getElementById("filterCategory");
    const searchInput = document.getElementById("searchInput");

    const movementForm = document.getElementById("movementForm");
    const movementTypeInput = document.getElementById("movementType");
    const movementProductSelect = document.getElementById("movementProduct");
    const movementQuantityInput = document.getElementById("movementQuantity");
    const movementDateInput = document.getElementById("movementDate");
    const movementNoteInput = document.getElementById("movementNote");
    const clearMovementFormBtn = document.getElementById("clearMovementForm");
    const movementsTableBody = document.getElementById("movementsTableBody");
    const movementsCountPill = document.getElementById("movementsCountPill");

    const orderItemForm = document.getElementById("orderItemForm");
    const orderProductSelect = document.getElementById("orderProduct");
    const orderQuantityInput = document.getElementById("orderQuantity");
    const orderNoteInput = document.getElementById("orderNote");
    const clearOrderItemFormBtn = document.getElementById("clearOrderItemForm");
    const currentOrderTableBody = document.getElementById("currentOrderTableBody");
    const currentOrderCountPill = document.getElementById("currentOrderCountPill");
    const clearCurrentOrderBtn = document.getElementById("clearCurrentOrder");
    const confirmOrderBtn = document.getElementById("confirmOrder");
    const ordersTableBody = document.getElementById("ordersTableBody");
    const ordersCountPill = document.getElementById("ordersCountPill");

    const barcodeSearchInput = document.getElementById("barcodeSearchInput");
    const barcodeResultBox = document.getElementById("barcodeResultBox");
    const searchBarcodeLocalBtn = document.getElementById("searchBarcodeLocal");
    const searchBarcodeExternalBtn =
      document.getElementById("searchBarcodeExternal");

    // ---------------- UTILITY ----------------
    function getProductById(id) {
      return products.find((p) => p.id === id);
    }

    function computeSalePrice() {
      const purchase = parseFloat(purchasePriceInput.value) || 0;
      const markup = parseFloat(markupPercentInput.value) || 0;
      const sale = purchase * (1 + markup / 100);
      salePriceInput.value = sale.toFixed(2);
      salePriceHint.textContent =
        "Calcolato automaticamente: " +
        formatCurrency(sale) +
        " (puoi comunque modificarlo a mano).";
    }

    purchasePriceInput.addEventListener("input", computeSalePrice);
    markupPercentInput.addEventListener("input", computeSalePrice);

    function clearProductForm() {
      productForm.reset();
      productQuantityInput.value = "0";
      purchasePriceInput.value = "0";
      markupPercentInput.value = "30";
      salePriceInput.value = "0";
      purchaseDateInput.value = "";
      expiryDateInput.value = "";
      barcodeInput.value = "";

      productCategoryInput.value = "formaggi";
      categoryChips.querySelectorAll(".chip").forEach((c) => {
        if (c.getAttribute("data-category") === "formaggi") {
          c.classList.add("active");
        } else {
          c.classList.remove("active");
        }
      });

      salePriceHint.textContent =
        "Verr√† aggiornato automaticamente in base al ricarico.";
    }

    clearProductFormBtn.addEventListener("click", (e) => {
      e.preventDefault();
      clearProductForm();
    });

    categoryChips.addEventListener("click", (e) => {
      const chip = e.target.closest(".chip");
      if (!chip) return;
      const cat = chip.getAttribute("data-category");
      productCategorySelect.value = cat;
      categoryChips.querySelectorAll(".chip").forEach((c) => {
        c.classList.toggle("active", c === chip);
      });
    });

    productCategorySelect.addEventListener("change", () => {
      const cat = productCategorySelect.value;
      categoryChips.querySelectorAll(".chip").forEach((c) => {
        c.classList.toggle(
          "active",
          c.getAttribute("data-category") === cat
        );
      });
    });

    function readImageAsBase64(file) {
      return new Promise((resolve, reject) => {
        if (!file) {
          resolve(null);
          return;
        }
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ---------------- INVENTARIO LOGICA ----------------
    function renderProductsTable() {
      productsTableBody.innerHTML = "";
      let filtered = [...products];

      const catFilter = filterCategorySelect.value;
      if (catFilter !== "all") {
        filtered = filtered.filter((p) => p.category === catFilter);
      }

      const search = searchInput.value.trim().toLowerCase();
      if (search) {
        filtered = filtered.filter((p) => {
          const name = (p.name || "").toLowerCase();
          const barcode = (p.barcode || "").toLowerCase();
          return name.includes(search) || barcode.includes(search);
        });
      }

      filtered.sort((a, b) => (a.name || "").localeCompare(b.name || ""));

      for (const p of filtered) {
        const tr = document.createElement("tr");

        const tdPhoto = document.createElement("td");
        if (p.photoBase64) {
          const img = document.createElement("img");
          img.src = p.photoBase64;
          img.alt = p.name || "Foto prodotto";
          img.className = "thumbnail";
          tdPhoto.appendChild(img);
        } else {
          tdPhoto.innerHTML = "<span class='muted'>-</span>";
        }

        const tdName = document.createElement("td");
        const nameEl = document.createElement("div");
        nameEl.textContent = p.name || "";
        const subEl = document.createElement("div");
        subEl.className = "text-small muted";
        subEl.textContent = p.barcode ? "Barcode: " + p.barcode : "Senza barcode";
        tdName.appendChild(nameEl);
        tdName.appendChild(subEl);

        const tdCat = document.createElement("td");
        tdCat.innerHTML =
          "<span class='badge badge-cat'>" + readableCategory(p.category) + "</span>";

        const tdQty = document.createElement("td");
        tdQty.className = "text-right";
        tdQty.textContent = (Number(p.quantity) || 0).toLocaleString("it-IT");

        const tdAcq = document.createElement("td");
        tdAcq.className = "text-right";
        tdAcq.textContent = formatCurrency(p.purchasePrice);

        const tdVend = document.createElement("td");
        tdVend.className = "text-right";
        tdVend.textContent = formatCurrency(p.salePrice);

        const tdScad = document.createElement("td");
        tdScad.textContent = p.expiryDate ? formatDate(p.expiryDate) : "-";

        const tdBarcode = document.createElement("td");
        tdBarcode.className = "text-small";
        tdBarcode.textContent = p.barcode || "-";

        const tdActions = document.createElement("td");
        const editBtn = document.createElement("button");
        editBtn.className = "btn-small btn-secondary";
        editBtn.textContent = "Modifica";
        editBtn.addEventListener("click", () => loadProductIntoForm(p.id));

        const delBtn = document.createElement("button");
        delBtn.className = "btn-small btn-danger";
        delBtn.style.marginLeft = "4px";
        delBtn.textContent = "Elimina";
        delBtn.addEventListener("click", () => deleteProduct(p.id));

        tdActions.appendChild(editBtn);
        tdActions.appendChild(delBtn);

        tr.appendChild(tdPhoto);
        tr.appendChild(tdName);
        tr.appendChild(tdCat);
        tr.appendChild(tdQty);
        tr.appendChild(tdAcq);
        tr.appendChild(tdVend);
        tr.appendChild(tdScad);
        tr.appendChild(tdBarcode);
        tr.appendChild(tdActions);

        productsTableBody.appendChild(tr);
      }

      inventoryCountPill.textContent = filtered.length + " prodotti";
    }

    function loadProductIntoForm(id) {
      const p = getProductById(id);
      if (!p) return;

      productNameInput.value = p.name || "";
      productCategoryInput.value = p.category || "formaggi";
      productQuantityInput.value = Number(p.quantity) || 0;
      purchasePriceInput.value = Number(p.purchasePrice) || 0;
      markupPercentInput.value = Number(p.markupPercent) || 0;
      salePriceInput.value = Number(p.salePrice) || 0;
      purchaseDateInput.value = p.purchaseDate || "";
      expiryDateInput.value = p.expiryDate || "";
      barcodeInput.value = p.barcode || "";

      categoryChips.querySelectorAll(".chip").forEach((c) => {
        c.classList.toggle(
          "active",
          c.getAttribute("data-category") === p.category
        );
      });

      salePriceHint.textContent =
        "Stai modificando un prodotto esistente. Ricorda di salvare.";
    }

    function deleteProduct(id) {
      if (!confirm("Vuoi davvero eliminare questo prodotto?")) return;

      products = products.filter((p) => p.id !== id);
      movements = movements.filter((m) => m.productId !== id);
      orders.forEach((o) => {
        o.items = o.items.filter((it) => it.productId !== id);
      });
      currentOrderItems = currentOrderItems.filter((it) => it.productId !== id);

      saveAndSync();
      renderProductsTable();
      populateProductSelects();
      renderMovementsTable();
      renderCurrentOrder();
      renderOrdersTable();

      showToast("Prodotto eliminato.");
    }

    filterCategorySelect.addEventListener("change", renderProductsTable);
    searchInput.addEventListener("input", renderProductsTable);

    productForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = productNameInput.value.trim();
      if (!name) {
        showToast("Inserisci il nome del prodotto.");
        return;
      }

      const category = productCategoryInput.value;
      const quantity = parseFloat(productQuantityInput.value) || 0;
      const purchasePrice = parseFloat(purchasePriceInput.value) || 0;
      const markupPercent = parseFloat(markupPercentInput.value) || 0;
      const salePrice = parseFloat(salePriceInput.value) || 0;
      const purchaseDate = purchaseDateInput.value || null;
      const expiryDate = expiryDateInput.value || null;
      const barcode = barcodeInput.value.trim() || null;

      let photoBase64 = null;
      if (photoInput.files && photoInput.files[0]) {
        try {
          photoBase64 = await readImageAsBase64(photoInput.files[0]);
        } catch (err) {
          console.error("Errore lettura immagine:", err);
          showToast("Impossibile leggere la foto, verr√† ignorata.");
        }
      }

      const now = new Date().toISOString();
      let existing = products.find(
        (p) => p.name.toLowerCase() === name.toLowerCase() && p.category === category
      );

      if (existing) {
        existing.quantity = quantity;
        existing.purchasePrice = purchasePrice;
        existing.markupPercent = markupPercent;
        existing.salePrice = salePrice;
        existing.purchaseDate = purchaseDate;
        existing.expiryDate = expiryDate;
        existing.barcode = barcode;
        existing.updatedAt = now;
        if (photoBase64) existing.photoBase64 = photoBase64;
        showToast("Prodotto aggiornato.");
      } else {
        const id = "prod_" + Date.now() + "_" + Math.random().toString(16).slice(2);
        const newProduct = {
          id,
          name,
          category,
          quantity,
          purchasePrice,
          markupPercent,
          salePrice,
          purchaseDate,
          expiryDate,
          barcode,
          createdAt: now,
          updatedAt: now,
        };
        if (photoBase64) newProduct.photoBase64 = photoBase64;
        products.push(newProduct);
        showToast("Prodotto aggiunto.");
      }

      saveAndSync();
      renderProductsTable();
      populateProductSelects();
      renderCurrentOrder();
      renderOrdersTable();
      clearProductForm();
    });

    // ---------------- MOVIMENTI ----------------
    function renderMovementsTable() {
      movementsTableBody.innerHTML = "";
      const sorted = movements.slice().sort((a, b) =>
        (a.date || "") > (b.date || "") ? -1 : 1
      );

      for (const m of sorted) {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = m.date ? formatDate(m.date) : "-";

        const tdProduct = document.createElement("td");
        const p = getProductById(m.productId);
        tdProduct.textContent = p ? p.name : "(eliminato)";

        const tdType = document.createElement("td");
        tdType.innerHTML =
          "<span class='badge'>" +
          (m.type === "carico" ? "CARICO" : "SCARICO") +
          "</span>";

        const tdQty = document.createElement("td");
        tdQty.className = "text-right";
        tdQty.textContent = (Number(m.quantity) || 0).toLocaleString("it-IT");

        const tdNote = document.createElement("td");
        tdNote.className = "text-small";
        tdNote.textContent = m.note || "";

        tr.appendChild(tdDate);
        tr.appendChild(tdProduct);
        tr.appendChild(tdType);
        tr.appendChild(tdQty);
        tr.appendChild(tdNote);

        movementsTableBody.appendChild(tr);
      }

      movementsCountPill.textContent = sorted.length + " movimenti";
    }

    movementForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const type = movementTypeInput.value;
      const productId = movementProductSelect.value;
      const quantity = parseFloat(movementQuantityInput.value) || 0;
      const date = movementDateInput.value || todayISO();
      const note = movementNoteInput.value.trim();

      const p = getProductById(productId);
      if (!p) {
        showToast("Seleziona un prodotto valido.");
        return;
      }
      if (quantity <= 0) {
        showToast("Inserisci una quantit√† maggiore di zero.");
        return;
      }

      const delta = type === "carico" ? quantity : -quantity;
      const newQty = (Number(p.quantity) || 0) + delta;
      if (newQty < 0) {
        showToast("Lo scarico supererebbe la quantit√† disponibile.");
        return;
      }
      p.quantity = newQty;
      p.updatedAt = new Date().toISOString();

      const movement = {
        id: "mov_" + Date.now() + "_" + Math.random().toString(16).slice(2),
        type,
        productId,
        quantity,
        date,
        note,
      };
      movements.push(movement);

      saveAndSync();
      renderProductsTable();
      renderMovementsTable();
      populateProductSelects();
      renderCurrentOrder();
      renderOrdersTable();

      movementQuantityInput.value = "0";
      movementNoteInput.value = "";
      showToast("Movimento registrato.");
    });

    clearMovementFormBtn.addEventListener("click", (e) => {
      e.preventDefault();
      movementForm.reset();
      movementQuantityInput.value = "0";
      movementDateInput.value = todayISO();
      movementNoteInput.value = "";
    });

    // ---------------- ORDINI ----------------
    function renderCurrentOrder() {
      currentOrderTableBody.innerHTML = "";

      currentOrderItems.forEach((item) => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        const p = getProductById(item.productId);
        tdName.textContent = p ? p.name : "(eliminato)";

        const tdQty = document.createElement("td");
        tdQty.className = "text-right";
        tdQty.textContent = (Number(item.quantity) || 0).toLocaleString(
          "it-IT"
        );

        const tdNote = document.createElement("td");
        tdNote.className = "text-small";
        tdNote.textContent = item.note || "";

        const tdActions = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.className = "btn-small btn-danger";
        delBtn.textContent = "Rimuovi";
        delBtn.addEventListener("click", () => {
          currentOrderItems = currentOrderItems.filter(
            (it) => it.id !== item.id
          );
          saveAndSync();
          renderCurrentOrder();
        });
        tdActions.appendChild(delBtn);

        tr.appendChild(tdName);
        tr.appendChild(tdQty);
        tr.appendChild(tdNote);
        tr.appendChild(tdActions);

        currentOrderTableBody.appendChild(tr);
      });

      currentOrderCountPill.textContent =
        currentOrderItems.length + " righe";
    }

    orderItemForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const productId = orderProductSelect.value;
      const quantity = parseFloat(orderQuantityInput.value) || 0;
      const note = orderNoteInput.value.trim();

      const p = getProductById(productId);
      if (!p) {
        showToast("Seleziona un prodotto valido.");
        return;
      }
      if (quantity <= 0) {
        showToast("Inserisci una quantit√† maggiore di zero.");
        return;
      }

      const item = {
        id: "orditem_" + Date.now() + "_" + Math.random().toString(16).slice(2),
        productId,
        quantity,
        note,
      };
      currentOrderItems.push(item);

      saveAndSync();
      renderCurrentOrder();

      orderQuantityInput.value = "0";
      orderNoteInput.value = "";
      showToast("Riga d‚Äôordine aggiunta.");
    });

    clearOrderItemFormBtn.addEventListener("click", (e) => {
      e.preventDefault();
      orderItemForm.reset();
      orderQuantityInput.value = "0";
      orderNoteInput.value = "";
    });

    clearCurrentOrderBtn.addEventListener("click", () => {
      if (!currentOrderItems.length) return;
      if (!confirm("Vuoi svuotare l‚Äôordine corrente?")) return;
      currentOrderItems = [];
      saveAndSync();
      renderCurrentOrder();
      showToast("Ordine corrente svuotato.");
    });

    function renderOrdersTable() {
      ordersTableBody.innerHTML = "";
      const sorted = orders.slice().sort((a, b) =>
        (a.createdAt || "") > (b.createdAt || "") ? -1 : 1
      );

      for (const ord of sorted) {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = ord.createdAt
          ? formatDate(ord.createdAt)
          : "-";

        const tdDesc = document.createElement("td");
        tdDesc.className = "text-small";
        tdDesc.textContent = ord.description || "Ordine prodotti";

        const tdCount = document.createElement("td");
        tdCount.className = "text-right";
        tdCount.textContent = (ord.items || []).length.toString();

        const tdStatus = document.createElement("td");
        const span = document.createElement("span");
        span.className =
          "badge " +
          (ord.status === "open"
            ? "badge-status-open"
            : "badge-status-closed");
        span.textContent = ord.status === "open" ? "APERTO" : "EVASO";
        tdStatus.appendChild(span);

        const tdActions = document.createElement("td");
        if (ord.status === "open") {
          const processBtn = document.createElement("button");
          processBtn.className = "btn-small btn";
          processBtn.textContent = "Evadi ordine";
          processBtn.addEventListener("click", () => processOrder(ord.id));
          tdActions.appendChild(processBtn);
        } else {
          tdActions.innerHTML =
            "<span class='muted text-small'>Gi√† evaso</span>";
        }

        tr.appendChild(tdDate);
        tr.appendChild(tdDesc);
        tr.appendChild(tdCount);
        tr.appendChild(tdStatus);
        tr.appendChild(tdActions);

        ordersTableBody.appendChild(tr);
      }

      ordersCountPill.textContent = sorted.length + " ordini";
    }

    confirmOrderBtn.addEventListener("click", () => {
      if (!currentOrderItems.length) {
        showToast("Non ci sono righe nell‚Äôordine corrente.");
        return;
      }

      const desc = prompt(
        "Descrizione ordine (es. ordine per weekend, fornitore X)",
        "Ordine prodotti"
      );
      const now = todayISO();
      const ord = {
        id: "ord_" + Date.now() + "_" + Math.random().toString(16).slice(2),
        description: desc || "Ordine prodotti",
        items: [...currentOrderItems],
        status: "open",
        createdAt: now,
      };
      orders.push(ord);

      currentOrderItems = [];
      saveAndSync();

      renderCurrentOrder();
      renderOrdersTable();

      showToast("Ordine salvato.");
    });

    function processOrder(orderId) {
      const ord = orders.find((o) => o.id === orderId);
      if (!ord) return;

      if (!confirm("Vuoi evadere questo ordine e aggiornare il magazzino?"))
        return;

      ord.items.forEach((item) => {
        const p = getProductById(item.productId);
        if (!p) return;
        const q = Number(item.quantity) || 0;
        p.quantity = (Number(p.quantity) || 0) + q;
        p.updatedAt = new Date().toISOString();
      });

      ord.status = "closed";

      saveAndSync();
      renderProductsTable();
      populateProductSelects();
      renderOrdersTable();

      showToast("Ordine evaso e magazzino aggiornato.");
    }

    // ---------------- BARCODE ----------------
    searchBarcodeLocalBtn.addEventListener("click", () => {
      const code = barcodeSearchInput.value.trim();
      if (!code) {
        showToast("Inserisci un barcode da cercare.");
        return;
      }

      const p = products.find(
        (prod) => (prod.barcode || "").toLowerCase() === code.toLowerCase()
      );
      if (!p) {
        barcodeResultBox.innerHTML =
          "<strong>Non trovato nel magazzino.</strong><br/>" +
          "Puoi cercarlo online oppure aggiungerlo manualmente nella sezione Inventario.";
        return;
      }

      barcodeResultBox.innerHTML =
        "<strong>Trovato:</strong> " +
        (p.name || "") +
        "<br/>" +
        "Categoria: " +
        readableCategory(p.category) +
        "<br/>" +
        "Quantit√†: " +
        (Number(p.quantity) || 0).toLocaleString("it-IT") +
        "<br/>" +
        (p.expiryDate
          ? "Scadenza: " + formatDate(p.expiryDate)
          : "Nessuna scadenza registrata.");
    });

    searchBarcodeExternalBtn.addEventListener("click", () => {
      const code = barcodeSearchInput.value.trim();
      if (!code) {
        showToast("Inserisci un barcode da cercare.");
        return;
      }
      const url =
        "https://www.google.com/search?q=" +
        encodeURIComponent(code + " prodotto barcode");
      window.open(url, "_blank");
    });

    // ---------------- POPOLAMENTO SELECT ----------------
    function populateProductSelects() {
      movementProductSelect.innerHTML = "";
      orderProductSelect.innerHTML = "";

      products
        .slice()
        .sort((a, b) => (a.name || "").localeCompare(b.name || ""))
        .forEach((p) => {
          const opt1 = document.createElement("option");
          opt1.value = p.id;
          opt1.textContent = p.name || "";
          movementProductSelect.appendChild(opt1);

          const opt2 = document.createElement("option");
          opt2.value = p.id;
          opt2.textContent = p.name || "";
          orderProductSelect.appendChild(opt2);
        });
    }

    // ---------------- INIT ----------------
    async function init() {
      // 1) carica da localStorage
      products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS) || "[]");
      movements = JSON.parse(localStorage.getItem(STORAGE_KEYS.MOVEMENTS) || "[]");
      orders = JSON.parse(localStorage.getItem(STORAGE_KEYS.ORDERS) || "[]");
      currentOrderItems = JSON.parse(
        localStorage.getItem(STORAGE_KEYS.CURRENT_ORDER) || "[]"
      );

      // 2) render veloce da locale
      computeSalePrice();
      movementDateInput.value = todayISO();
      renderProductsTable();
      populateProductSelects();
      renderMovementsTable();
      renderCurrentOrder();
      renderOrdersTable();
      updateFullscreenIcon();

      // 3) prova a sovrascrivere con il cloud
      const cloudOk = await loadFromCloud();
      if (cloudOk) {
        renderProductsTable();
        populateProductSelects();
        renderMovementsTable();
        renderCurrentOrder();
        renderOrdersTable();
        showToast("Dati caricati dal cloud.");
      }
    }

    init();
  </script>
</body>
</html>
